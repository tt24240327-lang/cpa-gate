import requests, hashlib, random, base64, time # v35.6_LOGIC_RESTORED
from flask import Flask, request, render_template_string, Response

app = Flask(__name__)

# [???] ???????? ????????
TELEGRAM_TOKEN = "7983385122:AAGK4kjCDpmerqfSwQL66ZDPL2MSOEV4An0"
CHAT_ID = "1898653696"
GA_ID = "G-1VH7D6BJTD"

# ????[v19.0] Iron Dome Defense Constants (???????? ????
WHITELIST_IPS = ['61.83.9.20'] # ??? ?????(???????????)

BOT_UA_KEYWORDS = [
    'bot', 'crawl', 'slurp', 'spider', 'naver', 'daum', 'google', 'phantom', 'headless',
    'vercel-screenshot', 'req/v3', 'python-requests', 'aiohttp', 'curl', 'wget',
    'selenium', 'playwright', 'cypress', 'go-http-client', 'okhttp', 'axios', 'guava'
]
BLOCKED_IP_PREFIXES = [
    '110.93.', '114.111.', '125.209.', '211.249.', '210.89.', '223.130.', 
    '216.73.', '34.', '35.', '52.', '54.', '13.107.', '20.', '192.30.', '140.82.', '185.199.'
]
VISITOR_LOGS = {} 

def is_bot_detected(ip, ua):
    if ip in WHITELIST_IPS:
        return False, None
    
    ua_lower = ua.lower()
    # 1. User-Agent ????????(vercel-screenshot, headless ??
    if any(keyword in ua_lower for keyword in BOT_UA_KEYWORDS):
        return True, f"UA_BLACK({ua[:20]})"
    
    # 2. IP ??????? (??? ?????? ??
    if any(ip.startswith(prefix) for prefix in BLOCKED_IP_PREFIXES):
        return True, "IP_BLACK"
    
    # 3. ??? ??? (1??? 3????? ??? ??????????)
    now = time.time()
    if ip not in VISITOR_LOGS:
        VISITOR_LOGS[ip] = []
    
    # ??? 1????? ????????
    VISITOR_LOGS[ip] = [t for t in VISITOR_LOGS[ip] if now - t < 1.0]
    VISITOR_LOGS[ip].append(now)
    
    if len(VISITOR_LOGS[ip]) > 3:
        return True, "BEHAVIOR_SPEED"
        
    return False, None

# [v35.6] Site Configurations (Restored)
SITE_CONFIGS = {
    "logistics-dynamics.kr": {"name": "Ï†ÑÎûµ Î¨ºÎ•ò Ïû¨Îã®", "color": "#1e40af", "desc": "Ï≤®Îã® Î¨ºÎ•ò ÏãúÏä§ÌÖú Ïó∞Íµ¨ Î∞è ÏµúÏ†ÅÌôî Í∏∞Í¥Ä", "font": "Nanum+Gothic"},
    "polymer-cleaning.co.kr": {"name": "ÌòÅÏã† ÌôòÍ≤Ω Ïó∞Íµ¨ÏÜå", "color": "#15803d", "desc": "ÏπúÌôòÍ≤Ω ÏÑ∏Ï†ï Í∏∞Ïà† Î∞è Í≥µÏ†ï Í∞úÎ∞ú", "font": "Nanum+Myeongjo"},
    "infra-maintenance.kr": {"name": "Ï∞®ÏÑ∏ÎåÄ Í∏∞Ïà† ÏÜîÎ£®ÏÖò", "color": "#b91c1c", "desc": "ÎèÑÏãú Í∏∞Î∞ò ÏãúÏÑ§ Ïú†ÏßÄÎ≥¥Ïàò Ï†ÑÎ¨∏ Í∏∞ÏóÖ", "font": "Noto+Sans+KR"},
    "fluid-flow.xyz": {"name": "Ïú†Ï≤¥ Ïó≠Ìïô Îç∞Ïù¥ÌÑ∞ÏÑºÌÑ∞", "color": "#0369a1", "desc": "Î∞∞Í¥Ä Î∞è ÏàòÏûêÏõê Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú Î∂ÑÏÑù", "font": "Nanum+Gothic+Coding"},
    "standard-eco.life": {"name": "ÌëúÏ§Ä ÏÉùÌôú ÌôòÍ≤Ω", "color": "#0d9488", "desc": "Ï£ºÍ±∞ ÌôòÍ≤Ω Í∞úÏÑ†ÏùÑ ÏúÑÌïú ÌëúÏ§Ä ÏßÄÏπ® ÏàòÎ¶Ω", "font": "Gowun+Batang"}
}
DEFAULT_CONFIG = {"name": "K-Tech ÌÜµÌï© Í∏∞Ïà†Ïõê", "color": "#00c73c", "desc": "Íµ≠Í∞Ä Í∏∞Ïà† ÌëúÏ§Ä Í∞ÄÏù¥ÎìúÎùºÏù∏ Ï†úÍ≥µ", "font": "Nanum+Gothic"}

# ü¶é [v35.6] Chameleon Deception Engine: Restored Logic
def get_chameleon_data(host, keyword=""):
    # Ìò∏Ïä§Ìä∏Î™ÖÏóêÏÑú ÏûêÎèôÏúºÎ°ú 'Í∑∏Îü¥ÎìØÌïú Ïù¥Î¶Ñ' ÏÉùÏÑ±
    subdomain = host.split('.')[0]
    h = int(hashlib.md5(host.encode()).hexdigest(), 16)
    random.seed(h)
    
    # 1. Í∏∞Í¥ÄÎ™Ö ÏÉùÏÑ±
    p_names = ["ÌïúÍµ≠", "Ï†ÑÍµ≠", "ÎØ∏Îûò", "Ï≤≠Ï†ï", "Ïö∞Î¶¨", "Î∞îÎ•∏", "Ï∞©Ìïú", "Ï†úÏùº", "ÎÇòÎàî", "ÌñâÎ≥µ", "ÏïàÏã¨", "Ïã†Î¢∞", "Î™ÖÌíà"]
    m_names = ["Í∏∞Ïà†", "Ïó∞Íµ¨", "Í∞úÎ∞ú", "ÏÜîÎ£®ÏÖò", "ÏãúÏä§ÌÖú", "ÌôòÍ≤Ω", "ÏÇ∞ÏóÖ", "Í≥µÌïô", "Îç∞Ïù¥ÌÑ∞", "Í¥ÄÎ¶¨", "ÏßÄÏõê"]
    s_names = ["Í≥µÏÇ¨", "Í∏∞ÏóÖ", "ÏÑºÌÑ∞", "ÌòëÌöå", "Ïó∞Íµ¨ÏÜå", "Í∞úÎ∞úÏõê", "Î≥∏Î∂Ä", "ÏßÄÏÇ¨", "ÏÇ¨ÏóÖÏÜå", "Ïó∞Ìï©"]
    
    # ÌÇ§ÏõåÎìúÎ≥Ñ ÌäπÌôî (ÏóÜÏúºÎ©¥ ÎûúÎç§)
    if "Ï≤≠ÏÜå" in keyword or "ÏûÖÏ£º" in keyword:
        m_names = ["ÌôòÍ≤Ω", "ÌÅ¥Î¶∞", "Ï≤≠ÏÜå", "ÏúÑÏÉù", "Î∞©Ïó≠", "ÏÑ∏Ï†ï", "ÎØ∏Ìôî"]
    elif "Ïù¥ÏÇ¨" in keyword or "Ïö©Îã¨" in keyword:
        m_names = ["Î¨ºÎ•ò", "Ïö¥ÏÜ°", "Ïù¥ÏÇ¨", "Ïù¥ÏÇøÏßê", "Ïö©Îã¨", "ÌôîÎ¨º"]
    elif "Ïö©Ï†ë" in keyword:
        m_names = ["Ïö©Ï†ë", "ÏÇ∞ÏóÖ", "ÌäπÏàò", "Í∏àÏÜç", "Î∞∞Í¥Ä", "ÏÑ§ÎπÑ"]
    elif "Î∞∞Í¥Ä" in keyword or "ÎàÑÏàò" in keyword or "ÎßâÌûò" in keyword:
        m_names = ["Î∞∞Í¥Ä", "ÏÑ§ÎπÑ", "ÌïòÏàòÍµ¨", "Î≥¥Ïàò", "ÎàÑÏàò", "ÏàòÏßà"]
    elif "ÏàòÏ†Ñ" in keyword or "Î≥ÄÍ∏∞" in keyword or "ÍµêÏ≤¥" in keyword:
        m_names = ["ÏãúÏÑ§", "ÏÑ§ÎπÑ", "Î≥¥Ïàò", "ÏàòÎ¶¨", "ÍµêÏ≤¥", "Ï£ºÍ±∞"]

    # ÏµúÏ¢Ö Í∏∞Í¥ÄÎ™Ö Ï°∞Ìï©
    site_name = f"{random.choice(p_names)} {random.choice(m_names)} {random.choice(s_names)}"
    
    # 2. ÌÖåÎßà ÏÉâÏÉÅ (ÎûúÎç§Ïù¥ÏßÄÎßå Í≥†Ï†ï)
    themes = [
        {"color": "#1e40af", "bg": "#f0f7ff"}, # Î∏îÎ£®
        {"color": "#15803d", "bg": "#f0fdf4"}, # Í∑∏Î¶∞
        {"color": "#b91c1c", "bg": "#fef2f2"}, # Î†àÎìú
        {"color": "#0369a1", "bg": "#f0f9ff"}, # Ïä§Ïπ¥Ïù¥
        {"color": "#0d9488", "bg": "#f0fdfa"}, # Ìã∏
        {"color": "#7c3aed", "bg": "#f5f3ff"}, # ÌçºÌîå
        {"color": "#475569", "bg": "#f8fafc"}  # Ïä¨Î†àÏù¥Ìä∏
    ]
    theme = random.choice(themes)
    
    # 3. Î¨∏ÏÑú Í≥†Ïú† Î≤àÌò∏ ÏÉùÏÑ±
    doc_id = f"KTS-{random.randint(2024, 2026)}-{h % 10000:04d}"
    
    # 4. Îã¥ÎãπÏûê Ï†ïÎ≥¥ ÏÉùÏÑ±
    last_names = ["ÍπÄ", "Ïù¥", "Î∞ï", "Ïµú", "Ï†ï", "Í∞ï", "Ï°∞", "Ïú§", "Ïû•"]
    ceo = random.choice(last_names) + random.choice(last_names) + random.choice(last_names)
    addr_cities = ["ÏÑúÏö∏Ïãú Í∞ïÎÇ®Íµ¨", "Í≤ΩÍ∏∞ÎèÑ Î∂ÑÎãπÍµ¨", "Ïù∏Ï≤úÏãú ÏÜ°ÎèÑ", "Î∂ÄÏÇ∞Ïãú Ìï¥Ïö¥ÎåÄÍµ¨", "ÎåÄÍµ¨Ïãú ÏàòÏÑ±Íµ¨", "ÎåÄÏ†ÑÏãú Ïú†ÏÑ±Íµ¨"]
    address = f"{random.choice(addr_cities)} {random.randint(10, 500)}Î≤àÍ∏∏ {random.randint(1, 100)} (v{random.randint(2, 5)}.0)"
    phone = f"070-{random.randint(3000, 8999)}-{random.randint(1000, 9999)}"

    return {
        "name": site_name,
        "theme": theme,
        "doc_id": doc_id,
        "ceo": ceo,
        "addr": address,
        "phone": phone,
        "font": random.choice(["Nanum+Gothic", "Nanum+Myeongjo", "Noto+Sans+KR", "Gowun+Batang"])
    }

def text_stylist(text, host):
    # Îã®Ïàú Î∞òÌôò (Î≥µÏû°Ìïú Î≥ÄÏ°∞ Î°úÏßÅ Ï†úÍ±∞ÌïòÏó¨ ÏïàÏ†ïÏÑ± ÌôïÎ≥¥)
    return text

def send_trace(msg):
    try:
        url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
        params = {"chat_id": CHAT_ID, "text": msg}
        requests.get(url, params=params, timeout=3)
    except:
        pass

# ????[v12.0] Tactical A/B DATA_MAP
DATA_MAP = {
    "cleaning": {
        "keywords": ["ÏûÖÏ£ºÏ≤≠ÏÜå", "Ïù¥ÏÇ¨Ï≤≠ÏÜå", "Í±∞Ï£ºÏ≤≠ÏÜå", "Ï≤≠ÏÜåÏóÖÏ≤¥", "Ï≤≠ÏÜå", "ÏûÖÏ£º Ï≤≠ÏÜå", "ÏÇ¨Î¨¥Ïã§Ï≤≠ÏÜå", "ÏßëÏ≤≠ÏÜå"],
        "image": "cleaning.jpg",
        "link_A": "https://www.replyalba.co.kr/pt/WwVCgW9E1R",
        "link_B": "https://albarich.com/pt/z2NytCt42i"
    },
    "moving": {
        "keywords": ["Ïù¥ÏÇ¨", "Ìè¨Ïû•Ïù¥ÏÇ¨", "ÏõêÎ£∏Ïù¥ÏÇ¨", "Ïö©Îã¨Ïù¥ÏÇ¨", "Ïù¥ÏÇøÏßê", "Ìè¨Ïû• Ïù¥ÏÇ¨", "Ïù¥ÏÇ¨ÏóÖÏ≤¥", "ÏÇ¨Î¨¥Ïã§Ïù¥ÏÇ¨", "Ïù¥ÏÇ¨Í≤¨Ï†Å"],
        "image": "moving.jpg",
        "link_A": "https://www.replyalba.co.kr/pt/LlocSbdUSY",
        "link_B": "https://albarich.com/pt/zdIDBDSzof"
    },
    "welding": {
        "keywords": ["Ïö©Ï†ë", "Ï∂úÏû•Ïö©Ï†ë", "ÏïåÍ≥§Ïö©Ï†ë", "Î∞∞Í¥ÄÏö©Ï†ë", "Ïö©Ï†ëÏóÖÏ≤¥", "Ïö©Ï†ëÏàòÎ¶¨", "ÏïåÍ≥§Ï∂úÏû•Ïö©Ï†ë", "Ïä§ÌÖê Ï∂úÏû•Ïö©Ï†ë"],
        "image": "welding.jpg",
        "link_A": "https://www.replyalba.co.kr/pt/XpBx9dZ5aE",
        "link_B": "https://albarich.com/pt/SROHH97olh"
    },
    "plumbing": {
        "keywords": ["ÎßâÌûò", "ÎàÑÏàò", "Îö´Ïùå", "Î≥ÄÍ∏∞ÎßâÌûò", "ÌïòÏàòÍµ¨ÎßâÌûò", "Î∞∞Í¥Ä", "Ïã±ÌÅ¨ÎåÄÎßâÌûò", "Ïó≠Î•ò", "ÎàÑÏàòÌÉêÏßÄ", "ÎàÑÏàòÏ†ÑÎ¨∏", "Î∞∞Í¥Ä ÎàÑÏàò", "Î≥ÄÍ∏∞Îö´ÎäîÏóÖÏ≤¥", "Î∞∞ÏàòÍµ¨ ÎßâÌûò", "ÌïòÏàòÍµ¨ Ïó≠Î•ò", "Î≥ÄÍ∏∞ Î¨º Ïïà ÎÇ¥Î†§Í∞ê", "ÌïòÏàòÍµ¨ Îö´Îäî ÏóÖÏ≤¥", "Î≥ÄÍ∏∞ Îö´Îäî Í≥≥", "Î∞∞Í¥ÄÎàÑÏàò"],
        "image": "plumbing.jpg",
        "link_A": "https://www.replyalba.co.kr/pt/GkVRvxfx1T",
        "link_B": "https://albarich.com/pt/QOaojnBV2v"
    },
    "fixture": {
        "keywords": ["ÏàòÏ†ÑÍµêÏ≤¥", "Î≥ÄÍ∏∞ÍµêÏ≤¥", "ÏÑ∏Î©¥ÎåÄÍµêÏ≤¥", "Î∂ÄÏÜçÍµêÏ≤¥", "ÏàòÏ†Ñ", "ÏÑ∏Î©¥ÎåÄ", "ÎèÑÍ∏∞ÍµêÏ≤¥", "ÏàòÏ†ÑÏàòÎ¶¨", "Î≥ÄÍ∏∞ÏàòÏ†Ñ", "ÌôîÏû•Ïã§ Î≥ÄÍ∏∞ ÍµêÏ≤¥", "ÏÑ∏Î©¥ÎåÄ ÍµêÏ≤¥", "Î≥ÄÍ∏∞ÏóÖÏ≤¥", "ÏàòÏ†ÑÏóÖÏ≤¥"],
        "image": "fixture.jpg",
        "link_A": "https://www.replyalba.co.kr/pt/FzYOdTzVNw",
        "link_B": "https://albarich.com/pt/vRUcqPts9r"
    },
    "demolition": {
        "keywords": ["Ï≤†Í±∞", "ÏõêÏÉÅÎ≥µÍµ¨", "ÏÉÅÍ∞ÄÏ≤†Í±∞", "Ïù∏ÌÖåÎ¶¨Ïñ¥Ï≤†Í±∞", "Í∞ÄÎ≤ΩÏ≤†Í±∞", "ÌèêÍ∏∞Î¨º"],
        "image": "demolition.jpg",
        "link_A": "https://www.replyalba.co.kr/pt/10qHjZwUanF",
        "link_B": "https://albarich.com/pt/NS5WRB4yKa"
    }
}


# ?? [v15.0] HASH-BASED SECURE OBFUSCATOR: ??? ??? ??? ???
SECRET_SALT = "yejin_love_2026"

def get_auto_code(keyword):
    # ???????? ???????? ??????(Salt)????? ???????? ???
    full_str = keyword + SECRET_SALT
    # MD5 ??? ??? ????6????????
    return hashlib.md5(full_str.encode()).hexdigest()[:6]

# ?? [v23.0] Bulk Automated KEYWORD_MAP
KEYWORD_MAP = {
    # [Ï≤≠ÏÜå]
    "8cf12edf": "Ïù¥ÏÇ¨Ï≤≠ÏÜå", "ca4a68a6": "ÏÇ¨Î¨¥Ïã§Ï≤≠ÏÜå", "c8a4cf5a": "ÏûÖÏ£ºÏ≤≠ÏÜå", "d7ea613c": "ÏßëÏ≤≠ÏÜå",
    "cb845113": "Ï≤≠ÏÜåÏóÖÏ≤¥",
    # [Ïù¥ÏÇ¨]
    "faf45575": "Ïù¥ÏÇ¨", "ce8a5ce4": "Ìè¨Ïû•Ïù¥ÏÇ¨", "c8b22f8a": "Ïù¥ÏÇ¨ÏóÖÏ≤¥", "d108d7a5": "ÏÇ¨Î¨¥Ïã§Ïù¥ÏÇ¨",
    "f79702a3": "Ïù¥ÏÇ¨Í≤¨Ï†Å", "fa13bc33": "ÏõêÎ£∏Ïù¥ÏÇ¨", "eeaf8186": "Ïö©Îã¨Ïù¥ÏÇ¨",
    # [Î∞∞Í¥Ä/ÎßâÌûò]
    "d0b65aba": "Î∞∞Í¥ÄÎàÑÏàò", "3e848ae6": "ÏàòÏ†ÑÍµêÏ≤¥", "66cb8240": "ÎàÑÏàòÌÉêÏßÄ",
    "8e2996c7": "Î∞∞Í¥Ä ÎàÑÏàò", "81edc02c": "Î≥ÄÍ∏∞ÎßâÌûò", "8745563e": "ÌïòÏàòÍµ¨ÎßâÌûò", "617a0005": "ÎàÑÏàòÌÉêÏßÄ",
    "5d19986d": "Î≥ÄÍ∏∞Îö´ÎäîÏóÖÏ≤¥", "a0ef0c00": "Ïã±ÌÅ¨ÎåÄÎßâÌûò", "e6d02452": "Î∞∞ÏàòÍµ¨ ÎßâÌûò", "35467a5c": "ÌïòÏàòÍµ¨ Ïó≠Î•ò",
    "9ce613e1": "Î≥ÄÍ∏∞ Î¨º Ïïà ÎÇ¥Î†§Í∞ê", "68943f44": "ÌïòÏàòÍµ¨ Îö´Îäî ÏóÖÏ≤¥", "c8abc514": "Î≥ÄÍ∏∞ Îö´Îäî Í≥≥",
    # [Ïö©Ï†ë]
    "dc19f4ea": "Ïö©Ï†ë", "af5f2375": "Ï∂úÏû•Ïö©Ï†ë", "c4c5ee7e": "Ïö©Ï†ëÏóÖÏ≤¥", "4a2f6816": "Î∞∞Í¥ÄÏö©Ï†ë",
    "87a3472b": "ÏïåÍ≥§Ïö©Ï†ë", "63b2da0a": "Ïö©Ï†ëÏàòÎ¶¨", "20186798": "ÏïåÍ≥§Ï∂úÏû•Ïö©Ï†ë", "ef310430": "Ïä§ÌÖê Ï∂úÏû•Ïö©Ï†ë",
    # [ÍµêÏ≤¥/ÏàòÎ¶¨]
    "ffbfdc28": "Î≥ÄÍ∏∞ÏàòÏ†Ñ", "be4adb64": "ÏàòÏ†ÑÍµêÏ≤¥", "a01f1db0": "Î≥ÄÍ∏∞ÍµêÏ≤¥", "b1585a85": "ÌôîÏû•Ïã§ Î≥ÄÍ∏∞ ÍµêÏ≤¥",
    "c2bddbcc": "ÏÑ∏Î©¥ÎåÄ ÍµêÏ≤¥", "b6f6c35f": "Î≥ÄÍ∏∞ÏóÖÏ≤¥", "3e750243": "ÏàòÏ†ÑÏóÖÏ≤¥",
    # [Í∏∞Ï°¥ Ìò∏ÌôòÏÑ±]
    "f2a3b4c5": "ÎàÑÏàòÌÉêÏßÄ", "d1e2f3g4": "ÏûÖÏ£ºÏ≤≠ÏÜå", "h5i6j7k8": "Ìè¨Ïû•Ïù¥ÏÇ¨"
}

# ?? [v18.0] REPORT_SNIPPETS: ??? ????? ??? ???
REPORT_SNIPPETS = {
    "cleaning": [
        "Í≥†Î∂ÑÏûê ÌôîÌïô ÏÑ±Î∂ÑÏùÑ ÌôúÏö©Ìïú Ï†ïÎ∞Ä ÏÑ∏Ï†ï Í≥µÏ†ïÏùÄ Ï£ºÍ±∞ ÌôòÍ≤ΩÏùò ÏúÑÏÉù ÌëúÏ§ÄÏùÑ ÌöçÍ∏∞Ï†ÅÏúºÎ°ú Í∞úÏÑ†Ìï©ÎãàÎã§.",
        "ÎØ∏ÏÑ∏Î®ºÏßÄ Î∞è ÏûîÎ•ò Ïò§ÏóºÎ¨ºÏßà Ï†úÍ±∞Î•º ÏúÑÌï¥ ÎÇòÎÖ∏ Îã®ÏúÑÏùò Í≥ÑÎ©¥ÌôúÏÑ±Ï†ú Î∞òÏùë ÏµúÏ†ÅÌôîÍ∞Ä ÌïÑÏàòÏ†ÅÏûÖÎãàÎã§.",
        "ÌôîÌïôÏ†Å Í±∞Îèô Î∂ÑÏÑùÏùÑ ÌÜµÌï¥ ÏÇ∞ÏÑ± Î∞è ÏïåÏπºÎ¶¨ÏÑ± ÏÑ∏Ï†úÏùò Ï§ëÌôî Í≥ºÏ†ïÏùÑ Ï†ïÎ∞ÄÌïòÍ≤å Ï†úÏñ¥Ìï¥Ïïº Ìï©ÎãàÎã§.",
        "Ï£ºÍ±∞ Í≥µÍ∞ÑÏùò Í≥µÍ∏∞Ïßà Í∞úÏÑ†ÏùÑ ÏúÑÌïú Ìï≠Í∑† ÏΩîÌåÖ Í∏∞Ïà†ÏùÄ Î∞ïÌÖåÎ¶¨ÏïÑ Ï¶ùÏãùÏùÑ Ìö®Ïú®Ï†ÅÏúºÎ°ú Ï†úÏñ¥ÌïòÎäî ÏÑ±Í≥ºÎ•º Î≥¥ÏòÄÏäµÎãàÎã§.",
        "ÌëúÎ©¥ Ïû•Î†• Ï†úÏñ¥ Í≥µÎ≤ïÏùÑ ÌÜµÌïú ÏΩîÌåÖÎßâ ÌòïÏÑ±ÏùÄ Ïò§Ïóº Î∞©ÏßÄ Î∞è Ïú†ÏßÄÍ¥ÄÎ¶¨ ÎπÑÏö© Ï†àÍ∞êÏùò ÌïµÏã¨ÏûÖÎãàÎã§."
    ],
    "moving": [
        "ÌôîÎ¨º Ï†ÅÏû¨ ÌïòÏ§ëÏùò ÎèôÏó≠ÌïôÏ†Å Î∂ÑÏÇ∞ ÏïåÍ≥†Î¶¨Ï¶òÏùÄ Ïö¥ÏÜ° Ï§ë ÌååÏÜêÏú®ÏùÑ Ïã§ÏãúÍ∞ÑÏúºÎ°ú Ï†ÄÍ∞êÌïòÎäî Í≥µÌïôÏ†Å Í∏∞Ï¥àÍ∞Ä Îê©ÎãàÎã§.",
        "Ïù¥Îèô Í≤ΩÎ°úÏùò ÏµúÏ†Å ÏµúÎã® Í≤ΩÎ°ú ÌÉêÏÉâ ÏïåÍ≥†Î¶¨Ï¶òÏùÄ ÏóêÎÑàÏßÄ Ìö®Ïú® Ï¶ùÎåÄÏôÄ Ïö¥ÏòÅ ÎπÑÏö© ÏµúÏ†ÅÌôîÏóê Í∏∞Ïó¨Ìï©ÎãàÎã§.",
        "Í≥†Ï∂© Î∂ÄÌïò Î∂ÑÎ∞∞ ÏãúÏä§ÌÖúÏùÑ ÌÜµÌïú Ï§ëÎüâÎ¨º ÏÉÅÌïòÏ∞® Í≥µÏ†ïÏùÄ ÏûëÏóÖÏûêÏùò ÏïàÏ†Ñ Î≥¥Í±¥ Î∞è ÏãúÏÑ§ Î≥¥Ìò∏Î•º Î≥¥Ïû•Ìï©ÎãàÎã§.",
        "Î¨ºÎ•ò ÏàòÏÜ° Ï≤¥Í≥ÑÏùò ÌëúÏ§ÄÌôî ÏûëÏóÖÏùÄ Ï≤¥Í≥ÑÏ†ÅÏù∏ ÏûêÏÇ∞ Î≥¥Ìò∏ Î∞è Ïö¥ÏÜ° Ïã†Î¢∞ÏÑ±ÏùÑ ÎÜíÏù¥Îäî ÌïµÏã¨ ÏßÄÌëúÏûÖÎãàÎã§.",
        "Ï∂©Í≤© Ìù°Ïàò ÌîÑÎ†àÏûÑÏõåÌÅ¨Î•º Ï†ÅÏö©Ìïú ÌäπÏàò Ï†ÅÏû¨ Í≥µÎ≤ïÏùÄ Ï†ïÎ∞Ä Í∏∞Í∏∞ Î∞è Í∞ÄÍµ¨ Î≥¥Ìò∏Ïóê ÌÉÅÏõîÌïú Ìö®Îä•ÏùÑ Î≥¥ÏûÖÎãàÎã§."
    ],
    "welding": [
        "Í∏àÏÜç Ï†ëÌï©Î∂ÄÏùò Ïó¥Î≥ÄÌòï Ï†úÏñ¥ ÏïåÍ≥†Î¶¨Ï¶òÏùÄ Íµ¨Ï°∞Î¨ºÏùò Ïû•Í∏∞Ï†Å Ïã†Î¢∞ÏÑ±Í≥º ÎÇ¥Íµ¨ÏÑ±ÏùÑ Î≥¥Ïû•ÌïòÎäî ÌïµÏã¨ Í∏∞Ïà†ÏûÖÎãàÎã§.",
        "Î∂ÑÏûê Ï°∞ÏßÅ Í≤∞Ìï© Î©îÏª§ÎãàÏ¶ò Î∂ÑÏÑùÏùÑ ÌÜµÌï¥ Ïö©Ï†ë HAZ Íµ¨Í∞ÑÏùò Î¨ºÎ¶¨Ï†Å Î≥ÄÌòïÏùÑ ÏµúÏÜåÌôîÌïòÎäî Í≥µÏ†ïÏùÑ ÏàòÎ¶ΩÌñàÏäµÎãàÎã§.",
        "ÎπÑÌååÍ¥¥ ÌÉêÏÉÅ Í∏∞Ïà†(UT/RT) Í∏∞Î∞òÏùò ÌíàÏßà Í≤ÄÏ¶ù ÏãúÏä§ÌÖúÏùÄ ÎØ∏ÏÑ∏ Í∑†Ïó¥ Ï†ÑÌååÎ•º ÏÇ¨Ï†Ñ Ï∞®Îã®ÌïòÎäî Ïó≠Ìï†ÏùÑ ÏàòÌñâÌï©ÎãàÎã§.",
        "ÌäπÏàò Ìï©Í∏àÏö© ÌîåÎü≠Ïä§ ÏµúÏ†Å Î∞∞Ìï©ÎπÑÎäî ÏÇ∞Ìôî Î∞©ÏßÄ Î∞è Ï†ëÌï© Í∞ïÎèÑ Í∑πÎåÄÌôîÎ•º ÏúÑÌïú ÌïÑÏàò Ïó∞Íµ¨ Í≤∞Í≥ºÏûÖÎãàÎã§.",
        "Í≥†Ïò® Í≥†Ïïï ÌôòÍ≤Ω ÌïòÏóêÏÑúÏùò Í∏àÏÜç Í≤∞Ìï© ÏïàÏ†ïÏÑ± ÌÖåÏä§Ìä∏Î•º ÌÜµÌï¥ ÏïàÏ†Ñ Í≥ÑÏàò 2.5 Ïù¥ÏÉÅÏùò ÌëúÏ§ÄÏùÑ Îã¨ÏÑ±ÌñàÏäµÎãàÎã§."
    ],
    "plumbing": [
        "ÎèÑÏãú ÏßÄÌïò Í¥ÄÎ°ú Ïú†Ï≤¥ ÌùêÎ¶Ñ Î∂ÑÏÑùÏùÑ ÌÜµÌï¥ Î∞∞Í¥Ä ÎÇ¥Î∂ÄÏùò ÏïïÎ†• Í∞ïÌïòÏôÄ Ïó≠Î•ò ÌòÑÏÉÅÏùÑ Ï†ïÎ∞ÄÌïòÍ≤å ÏßÑÎã®Ìï©ÎãàÎã§.",
        "ÎπÑÍµ¥Ï∞© Î≥µÍµ¨ Í≥µÌïôÏùÑ Ï†ÅÏö©Ìïú Í≥†Ïïï Ï†úÌåÖ Í≥µÎ≤ïÏùÄ Í∏∞Ï°¥ Îß§ÏÑ§Î¨ºÏùò ÏÜêÏÉÅ ÏóÜÏù¥ ÎÇ¥Î∂Ä Ïù¥Î¨ºÏßàÏùÑ ÏôÑÎ≤ΩÌûà Ï†úÍ±∞Ìï©ÎãàÎã§.",
        "Î†àÏù¥ÎÜÄÏ¶à Ïàò Í∏∞Î∞òÏùò Ïú†Ï≤¥ Ïó≠Ìïô ÏãúÎÆ¨Î†àÏù¥ÏÖòÏùÄ Î∞∞Í¥Ä ÏÑ§Í≥ÑÏùò ÏµúÏ†Å Íµ¨Î∞∞ Î∞è Ïú†ÏÜç Í≤∞Ï†ïÏóê ÌôúÏö©Îê©ÎãàÎã§.",
        "Ï¥àÏùåÌåå ÎàÑÏàò ÌÉêÏßÄ ÏïåÍ≥†Î¶¨Ï¶òÏùÄ ÎØ∏ÏÑ∏Ìïú ÏùåÌñ• ÌååÌòïÏùò Î≥ÄÏù¥Î•º Í∞êÏßÄÌïòÏó¨ 0.01mm Í∏âÏùò Í∑†Ïó¥ ÏúÑÏπòÎ•º ÌäπÏ†ïÌï©ÎãàÎã§.",
        "Î∞∞Í¥Ä ÎÇ¥Î≤Ω ÎÇòÎÖ∏ ÏΩîÌåÖ Í∏∞Ïà†ÏùÄ Ïù¥Î¨ºÏßà Ìù°Ï∞©ÏùÑ Î∞©ÏßÄÌïòÍ≥† Ïú†Ï≤¥ Ï†ÄÌï≠ÏùÑ ÏµúÏÜåÌôîÌïòÏó¨ ÌéåÌïë Ìö®Ïú®ÏùÑ ÎÜíÏûÖÎãàÎã§."
    ],
    "fixture": [
        "ÎÖ∏ÌõÑ ÏÑ§ÎπÑÏùò Í∏∞Í∏∞ Î≥¥Ïàò Î∞è ÍµêÏ≤¥ ÌëúÏ§Ä Í∞ÄÏù¥ÎìúÎùºÏù∏ÏùÄ ÏïàÏ†ïÏ†ÅÏù∏ Ï£ºÍ±∞ ÏàòÏûêÏõê Í¥ÄÎ¶¨Î•º ÏúÑÌïú ÌïÑÏàò ÏßÄÏπ®ÏûÖÎãàÎã§.",
        "ÏàòÏïï Ï†úÏñ¥ Î∞∏Î∏åÏùò ÏïïÎ†• ÌèâÌòï ÏµúÏ†Å ÏÑ§Í≥ÑÎäî Í∏âÍ≤©Ìïú Ïò®ÎèÑ Î≥ÄÌôî Î∞è Ïú†Îüâ Î≥ÄÎèô ÏöîÏù∏ÏùÑ ÏÇ¨Ï†Ñ Ï∞®Îã®Ìï©ÎãàÎã§.",
        "ÌôòÍ≤Ω ÏπúÌôîÏ†Å Ï†àÏàò Í∏∞Ïà† ÌëúÏ§ÄÏùÄ ISO Ïù∏Ï¶ù Í∏∞Ï§ÄÏóê Î∂ÄÌï©ÌïòÎäî ÏàòÏûêÏõê Î≥¥Ï°¥ Ìö®Ïú®ÏùÑ ÏûÖÏ¶ùÌïòÏòÄÏäµÎãàÎã§.",
        "ÏãúÏÑ§ ÍµêÏ≤¥ Ïãú Î∞úÏÉùÌïòÎäî ÏÜåÏùå Î∞è ÏßÑÎèô Ï∞®Îã® Í≥µÎ≤ïÏùÄ Ï£ºÍ±∞ ÏæåÏ†ÅÏÑ± Ìñ•ÏÉÅÏùÑ ÏúÑÌïú ÌïµÏã¨ ÏãúÍ≥µ ÌëúÏ§ÄÏûÖÎãàÎã§.",
        "Î∂ÄÏúÑÎ≥Ñ Î∂ÄÌíà Ìò∏ÌôòÏÑ± ÌëúÏ§ÄÌôî(Standardization)Îäî Ïú†ÏßÄÎ≥¥Ïàò Ìé∏ÏùòÏÑ±Í≥º Ïû•Í∏∞ Ïö¥ÏòÅ ÏïàÏ†ïÏÑ±ÏùÑ Î≥¥Ïû•Ìï©ÎãàÎã§."
    ]
}

# ?? [v15.0] ????????????? ??? ??? ?????
REVERSE_HASH_MAP = {}
def build_hash_map():
    # 1. ??? ????????????? ???
    all_kws = set(KEYWORD_MAP.values())
    for data in DATA_MAP.values():
        all_kws.update(data['keywords'])
    
    # 2. ??? ??? -> ???????? ??? ???
    for kw in all_kws:
        h_code = get_auto_code(kw)
        REVERSE_HASH_MAP[h_code] = kw

build_hash_map()

# ?? [v16.0] DYNAMIC BASE64 DECODER: ??? ??? ????????
def decode_keyword(encoded_str):
    try:
        # 1. Base64 ???????? (URL ??? ???)
        padding = '=' * (4 - len(encoded_str) % 4)
        decoded_bytes = base64.urlsafe_b64decode(encoded_str + padding)
        decoded_str = decoded_bytes.decode('utf-8')
        
        # 2. ??? ????? ????? ?????? ???????????
        if "|" in decoded_str:
            keyword, key = decoded_str.split("|")
            if key == SECRET_SALT:
                return keyword # '??????' ??? ???!
        return None
    except:
        return None

def get_keyword(code):
    # 1. ??? Base64 ?????(v16.0) - ??? ??? ???!
    dynamic_kw = decode_keyword(code)
    if dynamic_kw:
        return dynamic_kw
    
    # 2. ??? ??? ??? (v15.0)
    if code in REVERSE_HASH_MAP:
        return REVERSE_HASH_MAP[code]
    
    # 3. ??? ??? ??? (v14.0)
    if code in KEYWORD_MAP:
        return KEYWORD_MAP[code]
    
    # 4. ??? ?????? ??? (100% ??? ???)
    return code

# ????[v11.0] SEO Deception Engine

# ?? 50?????????? ??? ????????? (2023 ~ 2026)
DOC_DATABASE = [
    # 2026
    {"id": "KTS-2026-06", "cat": "hvac", "title": "????? ??? ?????? ?????? ????? ??? ???", "date": "2026-01-26", "desc": "????????????????(COP) ??????????????? ??????"},
    {"id": "KTS-2026-05", "cat": "homecare", "title": "??? ??? ??? ?????????? ??? ??? ???", "date": "2026-01-25", "desc": "?????????????VOCs) ???????????????? ??????????},
    {"id": "KTS-2026-04", "cat": "drain", "title": "??? ??????????? ??? ?????????? ???", "date": "2026-01-24", "desc": "???????????? ????? ??? ??? ????????????},
    {"id": "KTS-2026-03", "cat": "welding", "title": "??? ??????????????? ??????????????", "date": "2026-01-22", "desc": "TIG/??? ??? HAZ ??? ??????? ??PWHT ??? ????},
    {"id": "KTS-2026-02", "cat": "cleaning", "title": "???????? ??? ??? ????? ??? ?????, "date": "2026-01-20", "desc": "???????????????? ??? ??? ??? ??? ??? ????},
    {"id": "KTS-2026-01", "cat": "moving", "title": "??? ??? ??????????? ??? ??? ???", "date": "2026-01-15", "desc": "??? ??? ??? ???????? ??????????? ????? ??? ??? ???"},
    # 2025
    {"id": "KTS-2025-18", "cat": "structural", "title": "??????????????? ??? ??? ????? ??? ??? ???", "date": "2025-12-15", "desc": "FEM ??? ??? ??? ??? ?????? ????? ??? ??? ???"},
    {"id": "KTS-2025-17", "cat": "material", "title": "???????? ???????? ??? ??? ??????????? ????, "date": "2025-11-20", "desc": "???????? ????????????????? ???????????????},
    {"id": "KTS-2025-16", "cat": "robotics", "title": "????????????? ??? ??? ??? ??? ??????", "date": "2025-10-25", "desc": "???-??? ??? ??????????? ??? ??? ????? ??? ????????},
    {"id": "KTS-2025-15", "cat": "automation", "title": "AI ??? ??? ??? ??? ??? ??? ????? ??? ?????, "date": "2025-10-12", "desc": "????????????? ????? ??? ??? ??? ??? ?????},
    {"id": "KTS-2025-14", "cat": "energy", "title": "????? ????????????? ??????????????????", "date": "2025-09-28", "desc": "????????(PCM)?????????? ??? ???? ????? ??? ??? ???"},
    {"id": "KTS-2025-13", "cat": "fluid", "title": "??????????????????????? ???????? ??? ??? ???", "date": "2025-09-10", "desc": "??? ??? ?????????????????? ??? ??? ??? ??? ???"},
    {"id": "KTS-2025-12", "cat": "safety", "title": "??? ??? ??? ??? ???????? ??? ??? ??? ???", "date": "2025-09-05", "desc": "???????? ??? ??? ??? ??? ???????? ????},
    {"id": "KTS-2025-11", "cat": "coating", "title": "??? ?????? ???????? ?????? ????????", "date": "2025-08-14", "desc": "??? ??? ???????? ??? ????? ?????????? ??? ??? ????},
    {"id": "KTS-2025-10", "cat": "thermal", "title": "???????? ??? ??? ?????? ???????? ??? ???", "date": "2025-07-22", "desc": "?????? ??? ????? ???????? ??? ????? ??? ?????},
    # 2024
    {"id": "KTS-2024-12", "cat": "acoustic", "title": "??? ????? ??? ??? ??? ??? ??? ????? ?????? ???", "date": "2024-12-10", "desc": "??? ?????????? ??? ??? ???????? ?????????????"},
    {"id": "KTS-2024-11", "cat": "plasma", "title": "????? ?????? ??? ???????? ????????????? ???", "date": "2024-11-15", "desc": "??? ????? ?????? ???????? ??? ????? ???????? ???"},
    {"id": "KTS-2024-10", "cat": "optics", "title": "??? ???????? ????? ?????? ??? ??? ??????", "date": "2024-10-20", "desc": "??? ??? ?????????????? ??? ??????? ????? ??? ???"},
    {"id": "KTS-2024-09", "cat": "vibration", "title": "??? ?????????????????? ??? ????????", "date": "2024-09-12", "desc": "??? ??? ????????????? ???????? ???????? ???"},
    {"id": "KTS-2024-08", "cat": "polymer", "title": "???????????????? ???????? ???????? ???", "date": "2024-08-05", "desc": "??? ??? ????? ??? ??? ??? ??? ??? ???????????},
    {"id": "KTS-2024-07", "cat": "concrete", "title": "?????? ??????????? ??? ????? ??? ???", "date": "2024-07-15", "desc": "??? ??? ???????? ????????? ??? ?????????????"},
    {"id": "KTS-2024-06", "cat": "lubrication", "title": "??? ??? ?????? ??? ?????????????? ???", "date": "2024-06-22", "desc": "???????? ???????? ??? ????? ??? ???????? ??? ???"},
    {"id": "KTS-2024-05", "cat": "turbine", "title": "??????? ??????????? ??? ???????? ??? ??? ???", "date": "2024-05-18", "desc": "??? ??????? ???????? ???????? ????? ??? ???"},
    {"id": "KTS-2024-04", "cat": "additive", "title": "??? 3D ????????????? ??? ??? ??? ???", "date": "2024-04-10", "desc": "??? ??? ???????? ????? ??? ?????????????? ????},
    {"id": "KTS-2024-03", "cat": "semicon", "title": "EUV ??? ??????????? ??????????????? ????, "date": "2024-03-05", "desc": "????? ?????????????????? ??? ??? ??? ??? ???"},
    {"id": "KTS-2024-02", "cat": "wind", "title": "??? ??? ?????????? ??? ??? ??? ?????, "date": "2024-02-14", "desc": "??? ??? ?????????? ??? ??? ????? ???????? ???"},
    {"id": "KTS-2024-01", "cat": "hydrogen", "title": "??? ?????? ??? ???????????? ??? ?????", "date": "2024-01-20", "desc": "700bar ??? ??? ?????? ??? ?????????? ???????? ???"},
    # 2023 
    {"id": "KTS-2023-12", "cat": "smart", "title": "??????????? ?????????????IIoT) ??? ???", "date": "2023-12-15", "desc": "??? ?????????????????????????????? ??? ??? ???"},
    {"id": "KTS-2023-11", "cat": "gear", "title": "??? ?????? ??? ?????? ??? ??? ????? ???", "date": "2023-11-28", "desc": "??? ????? ????????? ???????? ??? ???????? ????},
    {"id": "KTS-2023-10", "cat": "vacuum", "title": "?????? ??? ??????????? ?????? ??? ?????, "date": "2023-10-12", "desc": "??? ??? ???????? ????????????? ??? ??? ??? ???"},
    {"id": "KTS-2023-09", "cat": "foundry", "title": "??? ???????? ??? ???????? ???????? ???", "date": "2023-09-22", "desc": "??????????????? ???????? ??? ??? ???????? ?????"},
    {"id": "KTS-2023-08", "cat": "filtration", "title": "??????? ?????????? ?????? ??? ??? ???????", "date": "2023-08-14", "desc": "??? ??? ??? ????? ??? ??? ???????? ??? ??? ?????},
    {"id": "KTS-2023-07", "cat": "pipeline", "title": "????????????? ??? ????? ??? ??? ??????", "date": "2023-07-05", "desc": "????????????? ?????? ??????????? ??? ???????"},
    {"id": "KTS-2023-06", "cat": "solar", "title": "?????????????????????? ??? ??? ???????????, "date": "2023-06-18", "desc": "????? ??? ???????????? ????????????? ????????"},
    {"id": "KTS-2023-05", "cat": "aerospace", "title": "?????????? ??? ??????????? ??? ???", "date": "2023-05-25", "desc": "??? ???????? ?????????? ????? ?????? ??? ????????"},
    {"id": "KTS-2023-04", "cat": "hydraulics", "title": "??? ???????? ??? ???????? ??? ???????", "date": "2023-04-12", "desc": "????????????????????? ??? ??? ??? ????? ??? ???"},
    {"id": "KTS-2023-03", "cat": "biotech", "title": "??? ??? ?????Bioreactor) ???????? ??? ??? ???", "date": "2023-03-20", "desc": "?????????????????????? ??? ??? ?????????? ?????},
    {"id": "KTS-2023-02", "cat": "ship", "title": "LNG ??????????? ??????????? ??? ?????, "date": "2023-02-15", "desc": "-163????? ?????? ???????? ????????? ??? ??? ???"},
    {"id": "KTS-2023-01", "cat": "mining", "title": "??? ??? ??? ???????? ????????????? ??? ???", "date": "2023-01-10", "desc": "????????????? Lidar ???????? ?????????? ??? ??????"}
]

# ?? [v13.0] ?????? ??? ???: ???????????????
def get_dynamic_chart(host):
    h = int(hashlib.md5(host.encode()).hexdigest(), 16)
    random.seed(h)
    points = [random.randint(20, 130) for _ in range(5)]
    color = random.choice(["#00c73c", "#1e40af", "#b91c1c", "#0d9488", "#0369a1"])
    path = f"M50,{points[0]} L150,{points[1]} L250,{points[2]} L350,{points[3]} L450,{points[4]}"
    circles = "".join([f'<circle cx="{i*100+50}" cy="{points[i]}" r="5" fill="#1e293b"/>' for i in range(5)])
    return f"""
    <svg viewBox="0 0 500 150" style="background:#fff; border:1px solid #eee; border-radius:8px; margin:20px 0;">
        <path d="{path}" fill="none" stroke="{color}" stroke-width="4"/>
        {circles}
    </svg>
    """

def get_term(host, key):
    h = int(hashlib.md5(host.encode()).hexdigest(), 16)
    random.seed(h)
    matrix = {
        "resources": ["?????????", "???????????", "??? ??? ?????, "??? ????????", "??? ???"],
        "about": ["????????", "??? ???", "????????", "??? ??????", "??? ?????"],
        "portal": ["??? ???", "??? ???????", "??? ???", "??? ?????, "??? ????????"],
        "report": ["??? ?????, "??? ?????", "??? ?????, "??? ?????, "??? ?????]
    }
    return random.choice(matrix.get(key, ["???"]))

BASE_HTML = """
<!DOCTYPE html>
<html lang="ko">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ ga_id }}"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', '{{ ga_id }}');
    </script>
    <link href="https://fonts.googleapis.com/css2?family={{ font_family }}&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <title>{{ title }} | {{ site_name }}</title>
    <style>
        body { font-family: '{{ font_family | replace("+", " ") }}', sans-serif; margin: 0; background: #f8fafc; color: #334155; letter-spacing: -0.5px; }
        .{{ cls_nav }} { background: white; padding: 20px 10%; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid {{ theme_color }}; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .{{ cls_nav }} a { text-decoration: none; color: #1e293b; font-weight: bold; margin-left: 30px; font-size: 14px; transition: 0.2s; }
        .{{ cls_nav }} a:hover { color: {{ theme_color }}; }
        .{{ cls_footer }} { background: #0f172a; color: #94a3b8; padding: 40px 10%; text-align: center; font-size: 11px; line-height: 2; border-top: 1px solid #1e293b; }
        .{{ cls_content }} { max-width: 1000px; margin: 40px auto; padding: 0 20px; min-height: 500px; }
        .section { background: white; padding: 35px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); margin-bottom: 25px; border: 1px solid #f1f5f9; }
        .card { display: block; background: white; padding: 25px; border: 1px solid #e2e8f0; border-radius: 8px; text-decoration: none; color: inherit; transition: 0.2s; position: relative; overflow: hidden; }
        .card:hover { border-color: {{ theme_color }}; transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
        .card h3 { margin: 0 0 10px 0; font-size: 18px; color: #1e293b; }
        .pagination { display: flex; justify-content: center; margin-top: 30px; gap: 10px; }
        .pagination a { padding: 8px 15px; border: 1px solid #ddd; background: white; color: #333; text-decoration: none; border-radius: 5px; }
        .pagination a.active { background: {{ theme_color }}; color: white; border-color: {{ theme_color }}; }
    </style>
</head>
<body>
    <div style="display:none;">DEPLOY_VER: v27.0</div>
    <div class="{{ cls_nav }}">
        <a href="/" style="font-size: 22px; font-weight: 900; color: {{ theme_color }}; margin: 0; letter-spacing: -1.5px;">{{ site_name }}</a>
        <div>
            <a href="/about">{{ terms.about }}</a>
            <a href="/resources">{{ terms.resources }}</a>
            <a href="/careers">??????</a>
            <a href="/contact">??????</a>
        </div>
    </div>
    <div class="{{ cls_content }}">{{ body_content | safe }}</div>
    <div class="{{ cls_footer }}">
        (??{{ site_name }} | {{ identity.addr }} | ?????: {{ identity.ceo }} | T. {{ identity.phone }}<br>
        Copyright ? 2026 {{ site_name }}. All rights reserved.
    </div>
</body>
</html>
"""

def get_config():
    host = request.host.split(':')[0].replace('www.', '')
    conf = SITE_CONFIGS.get(host, DEFAULT_CONFIG).copy()
    
    # ????[v11.0/v13.0] ??? ??DOM ?????????????
    h = hashlib.md5(host.encode()).hexdigest()
    random.seed(int(h[:8], 16))
    conf['identity'] = identity_gen(host)
    conf['cls_nav'] = "n_" + h[:5]
    conf['cls_footer'] = "f_" + h[5:10]
    conf['cls_content'] = "c_" + h[10:15]
    conf['terms'] = {
        "resources": get_term(host, "resources"),
        "about": get_term(host, "about"),
        "portal": get_term(host, "portal"),
        "report": get_term(host, "report")
    }
    
    return conf

# ????[v18.0] Deep Deception: ??? ??? ???????
def get_unique_report_content(host, category):
    h = int(hashlib.md5(host.encode()).hexdigest(), 16)
    random.seed(h)
    snippets = REPORT_SNIPPETS.get(category, REPORT_SNIPPETS["cleaning"])
    random.shuffle(snippets)
    def modulate(text):
        if h % 3 == 0: return text.replace("?????", "??").replace("??????.", "???.")
        elif h % 3 == 1: return text.replace("?????", "??? ??????????????.").replace("??????.", "??? ?????????????")
        return text
    modulated_snippets = [modulate(s) for s in snippets]
    report_text = ""
    for i, s in enumerate(modulated_snippets):
        report_text += f"<p style='line-height:1.8; margin-bottom:15px; text-align:justify;'>{s}</p>"
        if i == 1:
            report_text += f"<div style='background:#f1f5f9; padding:15px; border-radius:5px; font-size:12px; margin:20px 0; color:#475569; border-left:4px solid #94a3b8;'><strong>[??? ?????ID: {h % 99999:05d}]</strong><br>????????????? ??? ??? ???????? v{random.randint(2,4)}.0????? ???????????.</div>"
    return report_text

# ????[v22.0] Honeypot (?????: ????? ?????????? ?????
def get_honeypot_response(cham):
    body = f"""
    <div class="section" style="max-width:400px; margin: 100px auto; padding:40px; border-top: 5px solid {cham['theme']['color']};">
        <h2 style="text-align:center; color:#1e293b; margin-bottom:30px;">K-Tech Intranet Login</h2>
        <div style="margin-bottom:20px;">
            <label style="display:block; font-size:13px; color:#64748b; margin-bottom:5px;">Employee ID</label>
            <input type="text" style="width:100%; padding:10px; border:1px solid #e2e8f0; border-radius:5px; background:#f8fafc;" disabled value="Guest_Member">
        </div>
        <div style="margin-bottom:30px;">
            <label style="display:block; font-size:13px; color:#64748b; margin-bottom:5px;">Security Password</label>
            <input type="password" style="width:100%; padding:10px; border:1px solid #e2e8f0; border-radius:5px; background:#f8fafc;" disabled value="********">
        </div>
        <button style="width:100%; padding:12px; background:#94a3b8; color:white; border:none; border-radius:5px; font-weight:bold; cursor:not-allowed;">Access Restricted</button>
        <p style="margin-top:20px; font-size:12px; color:#ef4444; text-align:center;">????? IP ???????? ????????????????<br>?????????? ??? ?????????? ????????</p>
    </div>
    """
    return render_template_string(BASE_HTML, title="Intranet Gateway", body_content=body, site_name=cham['name'], theme_color="#94a3b8", ga_id=GA_ID, font_family=cham['font'], identity=cham, terms={"about": "Login", "resources": "System"}, cls_nav="n_lock", cls_footer="f_lock", cls_content="c_lock")

# ????[v22.0] Deep Deception: ??????????????? (??? ??? ??? ????
def get_professional_report(host, category, show_cta=False, target_url="#"):
    cham = get_chameleon_data(host, category)
    report_text = get_unique_report_content(host, category)
    
    cta_html = ""
    if show_cta:
        # ????[v22.0] Ultimate Stealth "The Ghost": ????????? ??????????
        # ??? ????? ?????? ?????????????????????????????????.
        b64_url = base64.b64encode(target_url.encode()).decode()
        cta_html = f"""
        <div id="cta-immediate-zone" style="margin-top:40px;"></div>
        <script>
            (function() {
                const u = atob('{b64_url}');
                const zone = document.getElementById('cta-immediate-zone');
                zone.innerHTML = `
                    <div style="padding:40px; background:#f8fafc; border:2px solid {cham['theme']['color']}; border-radius:12px; text-align:center; box-shadow: 0 10px 25px rgba(0,0,0,0.05);">
                        <h3 style="margin-bottom:12px; color:#1e293b; font-size:20px;">{category.upper()} ??? ??? ??? ???????</h3>
                        <p style="font-size:15px; color:#64748b; margin-bottom:25px;">????? ??? ??????????? ??? ????? ??? ?????????? ????????</p>
                        <a href="${{u}}" target="_blank" style="display:inline-block; padding:18px 60px; background:{cham['theme']['color']}; color:white; text-decoration:none; font-weight:bold; border-radius:8px; font-size:18px; box-shadow:0 8px 15px rgba(0,0,0,0.1); width: 80%; max-width: 400px;">??? ??? ????? ???????</a>
                    </div>
                `;
            })();
        </script>
        <style>@keyframes fadeIn {{ from {{ opacity: 0; transform: translateY(10px); }} to {{ opacity: 1; transform: translateY(0); }} }}</style>
        """

    content = f"""
    <div class="section">
        <div style="float:right; border:4px solid #e74c3c; color:#e74c3c; padding:10px 20px; font-weight:bold; transform:rotate(12deg); font-size:24px; border-radius:5px;">CONFIDENTIAL</div>
        <p style="color:{cham['theme']['color']}; font-weight:bold; font-size:14px;">[??????????????: {cham['doc_id']}]</p>
        <h1 style="color:#1e293b; margin-top:15px; font-size:32px; letter-spacing:-1px;">{category.upper()} Í≥†Îì± Í∏∞Ïà† Í≥µÏ†ï Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏ <span style="font-size:10px; color:#eee;">v34.0_SYNC</span></h1>
        <hr style="border:0; border-top:3px solid {cham['theme']['color']}22; margin:30px 0;">
        
        <div style="font-size:16px; color:#334155;">{report_text}</div>
        
        {cta_html}
        
        <p style="font-size:12px; color:#94a3b8; margin-top:50px; border-top:1px solid #eee; padding-top:20px; line-height:1.6;">
            ?????????{cham['name']}?????????? ????? ??? ?????????? ?????????. ???????? ??? ??? ??? ????????????????? ??? ????? ???????? ????????. (Hash: {hashlib.md5(host.encode()).hexdigest()[:16].upper()})
        </p>
    </div>
    """
    return render_template_string(BASE_HTML, title=f"{category.upper()} ??? ?????, body_content=content, site_name=cham['name'], theme_color=cham['theme']['color'], ga_id=GA_ID, font_family=cham['font'], identity=cham, terms={"about": "????????", "resources": "??????"}, cls_nav="n_doc", cls_footer="f_doc", cls_content="c_doc")

# ????[v19.0] Honeypot (?????: ????? ?????????
def get_honeypot_response(cham):
    body = f"""
    <div class="section" style="text-align:center; padding: 100px 20px;">
        <h1 style="color:#e74c3c; font-size:40px;">??? Access Denied</h1>
        <p style="margin-top:20px; color:#334155; font-size:18px;">??????????? ??????????? ?????????????????????</p>
        <div style="margin:40px auto; max-width:500px; padding:30px; background:#fef2f2; border:1px solid #fee2e2; border-radius:12px;">
            <p style="font-size:15px; color:#b91c1c;"><strong>??? ??? ??? (Code: {random.randint(10000, 99999)})</strong><br>?????? ???????? ?????????????????????????????</p>
        </div>
        <p style="font-size:13px; color:#94a3b8;">?????????????????? ??? ?????? ?????????, 24??? ??????????</p>
        <div style="margin-top:40px;" id="spinner">
            <div style="border:5px solid #f3f3f3; border-top:5px solid #e74c3c; border-radius:50%; width:40px; height:40px; animation: spin 1s linear infinite; margin:0 auto;"></div>
        </div>
    </div>
    <style>@keyframes spin {{ 0% {{ transform: rotate(0deg); }} 100% {{ transform: rotate(360deg); }} }}</style>
    """
    return render_template_string(BASE_HTML, title="Security Alert", body_content=body, site_name=cham['name'], theme_color="#e74c3c", ga_id=GA_ID, font_family=cham['font'], identity=cham, terms={"about": "???", "resources": "???"}, cls_nav="n_err", cls_footer="f_err", cls_content="c_err")

@app.route('/')
def index():
    user_ip = request.headers.get('X-Forwarded-For', request.remote_addr).split(',')[0]
    ua = request.headers.get('User-Agent', '').lower()
    host = request.host.split(':')[0].replace('www.', '')
    
    # ????[v19.0] Iron Dome ?????????? (UA + IP + Behavioral)
    keyword_raw = request.args.get('k', '')
    keyword = get_keyword(keyword_raw) or ""
    
    is_bot, bot_reason = is_bot_detected(user_ip, ua)
    
    cham = get_chameleon_data(host, keyword)
    
    # ?? [CASE 0] ??? ?????? ??? ?????????????
    if is_bot:
        report = f"????[???] {bot_reason} ???!\n?? ???: {request.host}\n?? IP: {user_ip}\n????UA: {ua[:40]}..."
        send_trace(report)
        return get_honeypot_response(cham)
    type_code = request.args.get('t', 'A')

    # ?? [CASE 1] ?????? ???????? ??? ??? -> "??? ????????"
    if is_bot or not keyword:
        report = f"?? [{cham['name']}] ???????? (??????? {is_bot})\n?? ???: {request.host}\n?? IP: {user_ip}\n????UA: {ua[:40]}..."
        send_trace(report)
        
        # ???????????? ?? (6????3~5????? ???)
        all_cards = [
            f'<a href="/a/moving" class="card" style="text-decoration:none;"><h3>??? ??? ??? ?????/h3><p style="color:#666; font-size:13px;">{cham["doc_id"]} ??? ??? ???</p></a>',
            f'<a href="/a/cleaning" class="card" style="text-decoration:none;"><h3>??? ??? ??? ????/h3><p style="color:#666; font-size:13px;">ISO-9001 ??? ??? ?????/p></a>',
            f'<a href="/a/welding" class="card" style="text-decoration:none;"><h3>??? ??????????</h3><p style="color:#666; font-size:13px;">??? ??? ????????????/p></a>',
            f'<a href="/a/plumbing" class="card" style="text-decoration:none;"><h3>??????? ??? ?????/h3><p style="color:#666; font-size:13px;">??????????????? ???</p></a>',
            f'<a href="/a/fixture" class="card" style="text-decoration:none;"><h3>??? ??? ??? ????/h3><p style="color:#666; font-size:13px;">???????? ????? ???</p></a>'
        ]
        random.seed(int(hashlib.md5(host.encode()).hexdigest()[:8], 16))
        count = random.randint(3, 5) # ?????? 3??5???????????????
        selected_cards = random.sample(all_cards, count)
        random.shuffle(selected_cards)

        body = f"""
        <div class="section" style="text-align:center; background:{cham['theme']['bg']}">
            <h1 style="color:{cham['theme']['color']}; border-bottom:3px solid {cham['theme']['color']}; display:inline-block;">{cham['name']}</h1>
            <p style="margin-top:10px; font-weight:bold;">{cham['doc_id']} ??? ??? ??? ??????</p>
            <div style="margin-top:15px; font-size:12px; color:#94a3b8;">??? ??????: 2026-01-27 | ??????: ???????/div>
        </div>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:20px;">
            {"".join(selected_cards)}
        </div>
        """
        resp = Response(render_template_string(BASE_HTML, title=cham['name'], body_content=body, site_name=cham['name'], theme_color=cham['theme']['color'], site_desc=cham['doc_id'], ga_id=GA_ID, font_family=cham['font'], identity=cham, terms={"about": "????????", "resources": "??????"}, cls_nav="n_main", cls_footer="f_main", cls_content="c_main"))
        resp.headers['Cache-Control'] = 'no-store, no-cache, must-revalidate, max-age=0'
        return resp

    # ?? [CASE 2] ??? ??? -> [???] ??? ??? ???????????. ??????????????? ????? ???.
    selected_data = None
    category_key = "cleaning"
    for cat, data in DATA_MAP.items():
        if any(k in keyword for k in data['keywords']):
            selected_data = data
            category_key = cat
            break
    if not selected_data:
        selected_data = DATA_MAP["cleaning"]
    
    final_url = selected_data['link_A'] # ??? A??? ?????
    if type_code == 'B': final_url = selected_data['link_B']
    
    send_trace(f"[V35_3_STABLE_ASCII] Code: {keyword_raw} | Key: {keyword} ({category_key}) | IP: {user_ip} | UA: {ua[:50]}... | Link: {final_url}")
    
    # ?? [v20.0] ??????????????? ??? ????????????? (??? ??? ???)
    resp = Response(get_professional_report(host, category_key, show_cta=True, target_url=final_url))
    resp.headers['Cache-Control'] = 'no-store, no-cache, must-revalidate, max-age=0'
    return resp

@app.route('/resources')
def resources():
    host = request.host.split(':')[0].replace('www.', '')
    cham = get_chameleon_data(host)
    page = request.args.get('page', 1, type=int)
    per_page = 10
    total_docs = len(DOC_DATABASE)
    total_pages = (total_docs + per_page - 1) // per_page
    start = (page - 1) * per_page
    end = start + per_page
    docs = DOC_DATABASE[start:end]

    list_html = ""
    for d in docs:
        list_html += f"""
        <div style="padding:22px; border-bottom:1px solid #eee;">
            <a href="/a/{d['cat']}" style="text-decoration:none; color:{cham['theme']['color']}; font-weight:bold;">[{d['id']}] {d['title']}</a>
            <p style="font-size:13px; color:#666; margin-top:8px;">{d['desc']}</p>
        </div>
        """
    
    pagination_html = '<div class="pagination">'
    for p in range(1, total_pages + 1):
        active_class = 'active' if p == page else ''
        pagination_html += f'<a href="/resources?page={p}" class="{active_class}">{p}</a>'
    pagination_html += '</div>'

    content = f"""
    <div class="section">
        <h1 style="color:{cham['theme']['color']}; border-bottom:3px solid {cham['theme']['color']}; display:inline-block;">??? ?????/h1>
        <div style="margin-top:20px;">{list_html}</div>
        {pagination_html}
    </div>
    """
    return render_template_string(BASE_HTML, title="??? ?????, body_content=content, site_name=cham['name'], theme_color=cham['theme']['color'], ga_id=GA_ID, font_family=cham['font'], identity=cham, terms={"about": "????????", "resources": "??????"}, cls_nav="n_res", cls_footer="f_res", cls_content="c_res")

@app.route('/about')
def about():
    host = request.host.split(':')[0].replace('www.', '')
    cham = get_chameleon_data(host)
    content = f'<div class="section"><h1>????????</h1><p style="line-height:2;">{cham["name"]}??{request.host} ??????????? ??? ???????? ?????????????????????????</p></div>'
    return render_template_string(BASE_HTML, title="????????", body_content=content, site_name=cham['name'], theme_color=cham['theme']['color'], ga_id=GA_ID, font_family=cham['font'], identity=cham, terms={"about": "????????", "resources": "??????"}, cls_nav="n_ab", cls_footer="f_ab", cls_content="c_ab")

@app.route('/careers')
def careers():
    host = request.host.split(':')[0].replace('www.', '')
    cham = get_chameleon_data(host)
    content = f'<div class="section"><h1>??????</h1><p>{cham["name"]}?? ?????????? ??? ????? ?????????? ??????????????????.</p></div>'
    return render_template_string(BASE_HTML, title="??????", body_content=content, site_name=cham['name'], theme_color=cham['theme']['color'], ga_id=GA_ID, font_family=cham['font'], identity=cham, terms={"about": "????????", "resources": "??????"}, cls_nav="n_car", cls_footer="f_car", cls_content="c_car")

@app.route('/contact')
def contact():
    host = request.host.split(':')[0].replace('www.', '')
    cham = get_chameleon_data(host)
    content = f'<div class="section"><h1>??????</h1><p>????? ???: admin@{host} | T. {cham["phone"]}</p></div>'
    return render_template_string(BASE_HTML, title="??????", body_content=content, site_name=cham['name'], theme_color=cham['theme']['color'], ga_id=GA_ID, font_family=cham['font'], identity=cham, terms={"about": "????????", "resources": "??????"}, cls_nav="n_con", cls_footer="f_con", cls_content="c_con")

@app.route('/<company>/<category>')
@app.route('/a/<category>')
def check_visitor(category, company=None):
    host = request.host.split(':')[0].replace('www.', '')
    cham = get_chameleon_data(host)
    user_ip = request.headers.get('X-Forwarded-For', request.remote_addr).split(',')[0]
    ua = request.headers.get('User-Agent', '').lower()
    
    # ????[v19.0] ??? ????????????? ????
    is_bot, bot_reason = is_bot_detected(user_ip, ua)
    if is_bot:
        return get_honeypot_response(cham)
    
    # ?????? ??? (??? ??? ???????? ???)
    target_data = DATA_MAP.get(category.lower())
    real_url = target_data['link_A'] if target_data else "#"
    
    # ?? [v20.0] ?????? CPA ????? ??? ??? ??????, ??????????? ??? ?????? ?????
    # ?? /a/ ?????????????????'???????? ?????????? ??? ??? ???????? ???????? ??????.
    # ?????? ?? ???????? '??? ??? ???' ?????????????????????
    show_button = not is_bot 
    
    resp = Response(get_professional_report(host, category.lower(), show_cta=show_button, target_url=real_url))
    resp.headers['Cache-Control'] = 'no-store, no-cache, must-revalidate, max-age=0'
    return resp

# --- ????[???] ??????(Sitemap) ??? ??? ??? ---
@app.route('/sitemap.xml')
def sitemap():
    conf = get_config()
    host = request.host.split(':')[0]
    # ??? ???????? ????? ??? ???
    pages = [
        {'loc': '/', 'freq': 'daily', 'pri': '1.0'},
        {'loc': '/about', 'freq': 'monthly', 'pri': '0.5'},
        {'loc': '/resources', 'freq': 'daily', 'pri': '0.8'},
        {'loc': '/careers', 'freq': 'monthly', 'pri': '0.5'},
        {'loc': '/contact', 'freq': 'monthly', 'pri': '0.5'}
    ]
    
    # DB????? ??? ??????????? ??? ?????????? ???
    categories = list(set(d['cat'] for d in DOC_DATABASE))
    for cat in categories:
        pages.append({'loc': f'/a/{cat}', 'freq': 'weekly', 'pri': '0.7'})

    # XML ?????? ?????????
    xml = '<?xml version="1.0" encoding="UTF-8"?>\n'
    xml += '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n'
    for p in pages:
        xml += f'  <url>\n    <loc>https://{host}{p["loc"]}</loc>\n'
        xml += f'    <changefreq>{p["freq"]}</changefreq>\n'
        xml += f'    <priority>{p["pri"]}</priority>\n  </url>\n'
    xml += '</urlset>'
    
    return Response(xml, mimetype='application/xml')

if __name__ == "__main__":
    app.run()
